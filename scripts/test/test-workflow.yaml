---

# Playbook for testing workflows. It starts workflow on Celos and compares workflow output with expected results.
# User has to provide "sample_time" and "workflow" parameters. "workflow" is workflow name e.g. "file-copy" and
# "sample_time" is the time that Celos will consider to start workflow e.g. 2013-12-20T20:00Z
# Example of running playbook: ansible-playbook -i provisioner/tmp/inventory -u celos  scripts/test/test-workflow.yaml --extra-vars "workflow=file-copy sample_time=2013-12-20T20:00Z"

- hosts: hadoop_masters
  gather_facts: no
  remote_user: celos
  vars:
    local_celos: ..
    remote_celos: ~/deploy
    celos_port: 8080
    celos_workflows_dir: /etc/celos/workflows
    celos_db_dir: /var/lib/celos/db
    sample_workflow: ~/deploy/samples/{{ workflow }}/{{ workflow }}.json
    sample_input: ~/deploy/samples/{{ workflow }}/input
    sample_oozie_workflow: ~/deploy/samples/{{ workflow }}/workflow

  tasks:

  - name: Prepare configuration dir
    shell: sudo rm -rf {{celos_workflows_dir}}/* && sudo mkdir -p {{celos_workflows_dir}}
      && sudo chown celos:celos {{celos_workflows_dir}}

  - name: Prepare database dir
    shell: sudo rm -rf {{celos_db_dir}}/* && sudo mkdir -p {{celos_db_dir}}
      && sudo chown celos:celos {{celos_db_dir}} && sudo chmod g+w -R {{celos_db_dir}}

  - name: Copy workflow to configuration dir
    shell: cp {{sample_workflow}} {{celos_workflows_dir}}

  - name: Prepare HDFS dirs
    shell: hadoop fs -rm -r -f /user/celos/samples/{{ workflow }}
      && hadoop fs -mkdir /user/celos/samples/{{ workflow }}
      && hadoop fs -mkdir /user/celos/samples/{{ workflow }}/output

  - name: Copy inputs to HDFS
    shell: hadoop fs -put {{sample_input}} hdfs:/user/celos/samples/{{ workflow }}/input

  - name: Copy Oozie workflow to HDFS
    shell: hadoop fs -put {{sample_oozie_workflow}} hdfs:/user/celos/samples/{{ workflow }}/workflow

  - name: Run scheduler
    shell: ~/deploy/scripts/run-scheduler.sh {{ sample_time }} {{ workflow }}

  - name: Verify produced outputs by comparing them against fixtures
    shell: ~/deploy/scripts/test/test-workflow-results.sh {{ workflow }}
